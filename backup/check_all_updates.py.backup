#!/usr/bin/env python3
"""
ì „ì²´ ì—…ë°ì´íŠ¸ ê¸°ë¡ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '.'))
from src.database import database_manager as db

def check_all_updates():
    """ëª¨ë“  ì—…ë°ì´íŠ¸ ê¸°ë¡ í™•ì¸"""
    
    with db.get_db_connection() as conn:
        cursor = conn.cursor()
        
        print("=" * 60)
        print("ğŸ“… ì „ì²´ UGC ì—…ë°ì´íŠ¸ ê¸°ë¡ í™•ì¸")
        print("=" * 60)
        
        # ugc_last_updated í•„ë“œê°€ ìˆëŠ” ëª¨ë“  ë°ì´í„°
        cursor.execute("""
            SELECT title, artist, tiktok_ugc_count, youtube_ugc_count, ugc_last_updated
            FROM songs 
            WHERE ugc_last_updated IS NOT NULL
            ORDER BY ugc_last_updated DESC
            LIMIT 20
        """)
        all_updates = cursor.fetchall()
        
        print(f"ğŸ”„ UGC ì—…ë°ì´íŠ¸ ê¸°ë¡ (ìµœê·¼ 20ê°œ):")
        for song in all_updates:
            tiktok_count = f"{song[2]:,}" if song[2] else "ë¯¸ìˆ˜ì§‘"
            youtube_count = f"{song[3]:,}" if song[3] else "ë¯¸ìˆ˜ì§‘"
            print(f"   ğŸ“± {song[0]} - {song[1]}")
            print(f"      TikTok: {tiktok_count}, YouTube: {youtube_count}")
            print(f"      ì—…ë°ì´íŠ¸: {song[4]}")
            print()
        
        # ë‚ ì§œë³„ ì—…ë°ì´íŠ¸ í†µê³„
        cursor.execute("""
            SELECT DATE(ugc_last_updated) as update_date,
                   COUNT(*) as total_updates,
                   COUNT(CASE WHEN tiktok_ugc_count IS NOT NULL THEN 1 END) as tiktok_updates,
                   COUNT(CASE WHEN youtube_ugc_count IS NOT NULL THEN 1 END) as youtube_updates
            FROM songs 
            WHERE ugc_last_updated IS NOT NULL
            GROUP BY DATE(ugc_last_updated)
            ORDER BY update_date DESC
        """)
        daily_stats = cursor.fetchall()
        
        print("ğŸ“Š ë‚ ì§œë³„ ì—…ë°ì´íŠ¸ í†µê³„:")
        for stat in daily_stats:
            print(f"   ğŸ“… {stat[0]}: ì´ {stat[1]}ê³¡ (TikTok {stat[2]}ê³¡, YouTube {stat[3]}ê³¡)")
        
        print("=" * 60)

if __name__ == "__main__":
    check_all_updates()