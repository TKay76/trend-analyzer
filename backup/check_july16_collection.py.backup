#!/usr/bin/env python3
"""
7ì›” 16ì¼ ìˆ˜ì§‘ ë°ì´í„° í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '.'))
from src.database import database_manager as db
from datetime import datetime

def check_july16_collection():
    """7ì›” 16ì¼ ìˆ˜ì§‘ëœ ë°ì´í„° í™•ì¸"""
    
    with db.get_db_connection() as conn:
        cursor = conn.cursor()
        
        print("=" * 70)
        print("ğŸ“… 2025-07-16 ìˆ˜ì§‘ ë°ì´í„° í™•ì¸")
        print("=" * 70)
        
        # ë‹¹ì¼ ì—…ë°ì´íŠ¸ëœ TikTok UGC ë°ì´í„°
        cursor.execute("""
            SELECT title, artist, tiktok_ugc_count, ugc_last_updated
            FROM songs 
            WHERE DATE(ugc_last_updated) = '2025-07-16'
              AND tiktok_ugc_count IS NOT NULL
            ORDER BY ugc_last_updated DESC
        """)
        tiktok_daily = cursor.fetchall()
        
        print(f"ğŸ­ ë‹¹ì¼ TikTok UGC ìˆ˜ì§‘: {len(tiktok_daily)}ê³¡")
        if tiktok_daily:
            print("   ğŸ“Š ìˆ˜ì§‘ëœ ê³¡ ëª©ë¡:")
            for i, song in enumerate(tiktok_daily[:10], 1):  # ìƒìœ„ 10ê³¡
                print(f"   {i:2d}. {song[0]} - {song[1]}: {song[2]:,}ê°œ")
                print(f"       ìˆ˜ì§‘ì‹œê°„: {song[3]}")
            if len(tiktok_daily) > 10:
                print(f"       ... ì™¸ {len(tiktok_daily)-10}ê³¡")
        print()
        
        # ë‹¹ì¼ ì—…ë°ì´íŠ¸ëœ YouTube UGC ë°ì´í„°  
        cursor.execute("""
            SELECT title, artist, youtube_ugc_count, ugc_last_updated
            FROM songs 
            WHERE DATE(ugc_last_updated) = '2025-07-16'
              AND youtube_ugc_count IS NOT NULL
            ORDER BY ugc_last_updated DESC
        """)
        youtube_daily = cursor.fetchall()
        
        print(f"ğŸ“º ë‹¹ì¼ YouTube UGC ìˆ˜ì§‘: {len(youtube_daily)}ê³¡")
        if youtube_daily:
            print("   ğŸ“Š ìˆ˜ì§‘ëœ ê³¡ ëª©ë¡:")
            for i, song in enumerate(youtube_daily[:10], 1):  # ìƒìœ„ 10ê³¡
                print(f"   {i:2d}. {song[0]} - {song[1]}: {song[2]:,}ê°œ")
                print(f"       ìˆ˜ì§‘ì‹œê°„: {song[3]}")
            if len(youtube_daily) > 10:
                print(f"       ... ì™¸ {len(youtube_daily)-10}ê³¡")
        print()
        
        # ë‹¹ì¼ ìˆ˜ì§‘ëœ í•´ì‹œíƒœê·¸ ë°ì´í„°
        cursor.execute("""
            SELECT COUNT(DISTINCT s.song_id) as songs_with_hashtags,
                   COUNT(*) as total_hashtags
            FROM song_hashtags s
            JOIN songs song ON s.song_id = song.id
            WHERE DATE(song.ugc_last_updated) = '2025-07-16'
        """)
        hashtag_stats = cursor.fetchone()
        
        print(f"ğŸ“Œ ë‹¹ì¼ í•´ì‹œíƒœê·¸ ìˆ˜ì§‘:")
        print(f"   ğŸµ í•´ì‹œíƒœê·¸ ìˆ˜ì§‘ ê³¡: {hashtag_stats[0]}ê³¡")
        print(f"   ğŸ“Š ì´ í•´ì‹œíƒœê·¸ ìˆ˜: {hashtag_stats[1]}ê°œ")
        if hashtag_stats[0] > 0:
            print(f"   ğŸ“ˆ ê³¡ë‹¹ í‰ê· : {hashtag_stats[1]/hashtag_stats[0]:.1f}ê°œ")
        print()
        
        # ë‹¹ì¼ ì¸ê¸° í•´ì‹œíƒœê·¸ TOP 10
        cursor.execute("""
            SELECT sh.hashtag, SUM(sh.count) as total_count
            FROM song_hashtags sh
            JOIN songs s ON sh.song_id = s.id
            WHERE DATE(s.ugc_last_updated) = '2025-07-16'
            GROUP BY sh.hashtag
            ORDER BY total_count DESC
            LIMIT 10
        """)
        popular_hashtags = cursor.fetchall()
        
        if popular_hashtags:
            print("ğŸ”¥ ë‹¹ì¼ ì¸ê¸° í•´ì‹œíƒœê·¸ TOP 10:")
            for i, (tag, count) in enumerate(popular_hashtags, 1):
                print(f"   {i:2d}. #{tag}: {count:,}íšŒ")
        print()
        
        # ë‹¹ì¼ ìˆ˜ì§‘ ê³¡ë³„ ìƒì„¸ í•´ì‹œíƒœê·¸ ì •ë³´ (ìƒìœ„ 5ê³¡)
        cursor.execute("""
            SELECT s.title, s.artist, s.tiktok_ugc_count, 
                   COUNT(sh.hashtag) as hashtag_count
            FROM songs s
            LEFT JOIN song_hashtags sh ON s.id = sh.song_id
            WHERE DATE(s.ugc_last_updated) = '2025-07-16'
              AND s.tiktok_ugc_count IS NOT NULL
            GROUP BY s.id, s.title, s.artist, s.tiktok_ugc_count
            ORDER BY s.tiktok_ugc_count DESC
            LIMIT 5
        """)
        top_songs = cursor.fetchall()
        
        if top_songs:
            print("ğŸ¯ ë‹¹ì¼ ìˆ˜ì§‘ TOP 5 ê³¡ ìƒì„¸ ì •ë³´:")
            for i, (title, artist, ugc_count, hashtag_count) in enumerate(top_songs, 1):
                print(f"   {i}. {title} - {artist}")
                print(f"      ğŸ­ TikTok UGC: {ugc_count:,}ê°œ")
                print(f"      ğŸ“Œ í•´ì‹œíƒœê·¸: {hashtag_count}ê°œ")
                
                # í•´ë‹¹ ê³¡ì˜ í•´ì‹œíƒœê·¸ ëª©ë¡
                cursor.execute("""
                    SELECT hashtag, count
                    FROM song_hashtags sh
                    JOIN songs s ON sh.song_id = s.id
                    WHERE s.title = ? AND s.artist = ?
                    ORDER BY count DESC
                    LIMIT 5
                """, (title, artist))
                song_hashtags = cursor.fetchall()
                
                if song_hashtags:
                    hashtag_list = [f"#{tag}({count})" for tag, count in song_hashtags]
                    print(f"      ğŸ·ï¸ ì£¼ìš” í•´ì‹œíƒœê·¸: {', '.join(hashtag_list)}")
                print()
        
        # ì „ì²´ í†µê³„ ë¹„êµ
        cursor.execute("""
            SELECT 
                COUNT(*) as total_songs,
                COUNT(CASE WHEN tiktok_ugc_count IS NOT NULL THEN 1 END) as tiktok_collected,
                COUNT(CASE WHEN youtube_ugc_count IS NOT NULL THEN 1 END) as youtube_collected
            FROM songs
        """)
        total_stats = cursor.fetchone()
        
        cursor.execute("""
            SELECT COUNT(DISTINCT song_id) as total_songs_with_hashtags,
                   COUNT(*) as total_hashtags
            FROM song_hashtags
        """)
        total_hashtag_stats = cursor.fetchone()
        
        print("ğŸ“Š ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ í˜„í™©:")
        print(f"   ğŸµ ì´ ê³¡ ìˆ˜: {total_stats[0]}ê³¡")
        print(f"   ğŸ­ TikTok UGC ìˆ˜ì§‘: {total_stats[1]}ê³¡")
        print(f"   ğŸ“º YouTube UGC ìˆ˜ì§‘: {total_stats[2]}ê³¡")
        print(f"   ğŸ“Œ í•´ì‹œíƒœê·¸ ë³´ìœ  ê³¡: {total_hashtag_stats[0]}ê³¡")
        print(f"   ğŸ“Š ì´ í•´ì‹œíƒœê·¸: {total_hashtag_stats[1]}ê°œ")
        print()
        
        print("ğŸ¯ 7ì›” 16ì¼ ìˆ˜ì§‘ ìš”ì•½:")
        print(f"   ğŸ­ TikTok: {len(tiktok_daily)}ê³¡")
        print(f"   ğŸ“º YouTube: {len(youtube_daily)}ê³¡") 
        print(f"   ğŸ“Œ í•´ì‹œíƒœê·¸: {hashtag_stats[1]}ê°œ")
        print(f"   ğŸ“ˆ ìˆ˜ì§‘ ì„±ê³¼: {'âœ… ì„±ê³µ' if len(tiktok_daily) > 0 else 'âŒ ìˆ˜ì§‘ ì—†ìŒ'}")
        print("=" * 70)

if __name__ == "__main__":
    check_july16_collection()