#!/usr/bin/env python3
"""
ë°ì´í„°ë² ì´ìŠ¤ ì‹œê°„ ë°ì´í„°ë¥¼ ë¡œì»¬ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '.'))
from src.database import database_manager as db

def update_db_timezone():
    """ë°ì´í„°ë² ì´ìŠ¤ì˜ ì‹œê°„ ë°ì´í„°ë¥¼ ë¡œì»¬ì‹œê°„ìœ¼ë¡œ ë³€í™˜"""
    
    with db.get_db_connection() as conn:
        cursor = conn.cursor()
        
        print("=" * 70)
        print("ğŸ• ë°ì´í„°ë² ì´ìŠ¤ ì‹œê°„ ë°ì´í„° ë¡œì»¬ì‹œê°„ ë³€í™˜")
        print("=" * 70)
        
        # 1. songs í…Œì´ë¸”ì˜ created_at ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
        print("ğŸ“Š songs í…Œì´ë¸” created_at ì—…ë°ì´íŠ¸ ì¤‘...")
        cursor.execute("""
            UPDATE songs 
            SET created_at = datetime(created_at, 'localtime')
            WHERE created_at IS NOT NULL
        """)
        songs_updated = cursor.rowcount
        print(f"   âœ… {songs_updated}ê°œ ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
        
        # 2. songs í…Œì´ë¸”ì˜ ugc_last_updated ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
        print("ğŸ“Š songs í…Œì´ë¸” ugc_last_updated ì—…ë°ì´íŠ¸ ì¤‘...")
        cursor.execute("""
            UPDATE songs 
            SET ugc_last_updated = datetime(ugc_last_updated, 'localtime')
            WHERE ugc_last_updated IS NOT NULL
        """)
        ugc_updated = cursor.rowcount
        print(f"   âœ… {ugc_updated}ê°œ ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
        
        # 3. daily_trends í…Œì´ë¸”ì˜ date ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
        print("ğŸ“Š daily_trends í…Œì´ë¸” date ì—…ë°ì´íŠ¸ ì¤‘...")
        cursor.execute("""
            UPDATE daily_trends 
            SET date = date(date, 'localtime')
            WHERE date IS NOT NULL
        """)
        trends_updated = cursor.rowcount
        print(f"   âœ… {trends_updated}ê°œ ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
        
        # 4. song_hashtags í…Œì´ë¸”ì˜ collected_date ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
        print("ğŸ“Š song_hashtags í…Œì´ë¸” collected_date ì—…ë°ì´íŠ¸ ì¤‘...")
        cursor.execute("""
            UPDATE song_hashtags 
            SET collected_date = date(collected_date, 'localtime')
            WHERE collected_date IS NOT NULL
        """)
        hashtags_updated = cursor.rowcount
        print(f"   âœ… {hashtags_updated}ê°œ ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ")
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        conn.commit()
        
        print("\nğŸ¯ ë³€í™˜ ì™„ë£Œ ìš”ì•½:")
        print(f"   ğŸ“Š songs.created_at: {songs_updated}ê°œ")
        print(f"   ğŸ“Š songs.ugc_last_updated: {ugc_updated}ê°œ")
        print(f"   ğŸ“Š daily_trends.date: {trends_updated}ê°œ")
        print(f"   ğŸ“Š song_hashtags.collected_date: {hashtags_updated}ê°œ")
        
        # 5. ë³€í™˜ í›„ ê²€ì¦ - 7ì›” 16ì¼ ë°ì´í„° í™•ì¸
        print("\nğŸ” ë³€í™˜ í›„ ê²€ì¦:")
        
        # 7ì›” 16ì¼ UGC ì—…ë°ì´íŠ¸ í™•ì¸
        cursor.execute("""
            SELECT COUNT(*) 
            FROM songs 
            WHERE DATE(ugc_last_updated) = '2025-07-16'
        """)
        july16_ugc = cursor.fetchone()[0]
        print(f"   ğŸ“… 7ì›” 16ì¼ UGC ì—…ë°ì´íŠ¸: {july16_ugc}ê°œ")
        
        # 7ì›” 16ì¼ í•´ì‹œíƒœê·¸ ìˆ˜ì§‘ í™•ì¸
        cursor.execute("""
            SELECT COUNT(DISTINCT song_id) 
            FROM song_hashtags 
            WHERE collected_date = '2025-07-16'
        """)
        july16_hashtags = cursor.fetchone()[0]
        print(f"   ğŸ“… 7ì›” 16ì¼ í•´ì‹œíƒœê·¸ ìˆ˜ì§‘: {july16_hashtags}ê°œ")
        
        # 7ì›” 16ì¼ í•´ì‹œíƒœê·¸ ì´ ê°œìˆ˜ í™•ì¸
        cursor.execute("""
            SELECT COUNT(*) 
            FROM song_hashtags 
            WHERE collected_date = '2025-07-16'
        """)
        july16_hashtag_count = cursor.fetchone()[0]
        print(f"   ğŸ“… 7ì›” 16ì¼ ì´ í•´ì‹œíƒœê·¸: {july16_hashtag_count}ê°œ")
        
        print("=" * 70)
        print("âœ… ë°ì´í„°ë² ì´ìŠ¤ ì‹œê°„ ë³€í™˜ ì™„ë£Œ!")
        print("=" * 70)

if __name__ == "__main__":
    update_db_timezone()