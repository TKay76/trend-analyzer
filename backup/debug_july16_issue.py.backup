#!/usr/bin/env python3
"""
7ì›” 16ì¼ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ë¬¸ì œ ë””ë²„ê¹… ìŠ¤í¬ë¦½íŠ¸
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '.'))
from src.database import database_manager as db
from datetime import datetime

def debug_july16_issue():
    """7ì›” 16ì¼ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ë¬¸ì œ ë””ë²„ê¹…"""
    
    with db.get_db_connection() as conn:
        cursor = conn.cursor()
        
        print("=" * 70)
        print("ğŸ” 7ì›” 16ì¼ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ë¬¸ì œ ë””ë²„ê¹…")
        print("=" * 70)
        
        # 1. ì „ì²´ ê³¡ ìˆ˜ í™•ì¸
        cursor.execute("SELECT COUNT(*) FROM songs")
        total_songs = cursor.fetchone()[0]
        print(f"ğŸ“Š ì´ ê³¡ ìˆ˜: {total_songs}ê°œ")
        
        # 2. TikTok IDê°€ ìˆëŠ” ê³¡ ìˆ˜ í™•ì¸
        cursor.execute("SELECT COUNT(*) FROM songs WHERE tiktok_id IS NOT NULL")
        tiktok_songs = cursor.fetchone()[0]
        print(f"ğŸ­ TikTok ID ë³´ìœ  ê³¡: {tiktok_songs}ê°œ")
        
        # 3. ìµœê·¼ ì¶”ê°€ëœ ê³¡ í™•ì¸ (7ì›” 16ì¼)
        cursor.execute("""
            SELECT title, artist, tiktok_id, created_at
            FROM songs 
            WHERE DATE(created_at) = '2025-07-16'
            ORDER BY created_at DESC
            LIMIT 10
        """)
        new_songs = cursor.fetchall()
        
        print(f"\nğŸ“… 7ì›” 16ì¼ ìƒˆë¡œ ì¶”ê°€ëœ ê³¡: {len(new_songs)}ê°œ")
        if new_songs:
            for i, song in enumerate(new_songs, 1):
                print(f"   {i}. {song[0]} - {song[1]} (ID: {song[2]}) - {song[3]}")
        
        # 4. ê¸°ì¡´ ê³¡ ì¤‘ TikTok ID ìˆì§€ë§Œ UGC ì—†ëŠ” ê³¡ í™•ì¸
        cursor.execute("""
            SELECT title, artist, tiktok_id, ugc_last_updated
            FROM songs 
            WHERE tiktok_id IS NOT NULL 
              AND tiktok_ugc_count IS NULL
            ORDER BY id DESC
            LIMIT 10
        """)
        missing_ugc = cursor.fetchall()
        
        print(f"\nâš ï¸ TikTok ID ìˆì§€ë§Œ UGC ë¯¸ìˆ˜ì§‘ ê³¡: {len(missing_ugc)}ê°œ")
        if missing_ugc:
            for i, song in enumerate(missing_ugc, 1):
                print(f"   {i}. {song[0]} - {song[1]} (ID: {song[2]}) - ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {song[3]}")
        
        # 5. ì¤‘ë³µ ë°ì´í„° ì²˜ë¦¬ í™•ì¸
        cursor.execute("""
            SELECT tiktok_id, COUNT(*) as count
            FROM songs 
            WHERE tiktok_id IS NOT NULL
            GROUP BY tiktok_id
            HAVING COUNT(*) > 1
        """)
        duplicates = cursor.fetchall()
        
        print(f"\nğŸ”„ ì¤‘ë³µ TikTok ID: {len(duplicates)}ê°œ")
        if duplicates:
            for tiktok_id, count in duplicates:
                print(f"   ID {tiktok_id}: {count}ê°œ ê³¡")
                
                # ì¤‘ë³µ ê³¡ ìƒì„¸ ì •ë³´
                cursor.execute("""
                    SELECT id, title, artist, tiktok_ugc_count, ugc_last_updated
                    FROM songs 
                    WHERE tiktok_id = ?
                    ORDER BY id
                """, (tiktok_id,))
                dup_songs = cursor.fetchall()
                
                for song in dup_songs:
                    ugc_status = f"{song[3]:,}" if song[3] else "ë¯¸ìˆ˜ì§‘"
                    print(f"      â†’ {song[0]}: {song[1]} - {song[2]} (UGC: {ugc_status}) - {song[4]}")
        
        # 6. í•´ì‹œíƒœê·¸ í…Œì´ë¸” í™•ì¸
        cursor.execute("SELECT COUNT(*) FROM song_hashtags")
        total_hashtags = cursor.fetchone()[0]
        print(f"\nğŸ“Œ ì´ í•´ì‹œíƒœê·¸ ìˆ˜: {total_hashtags}ê°œ")
        
        cursor.execute("""
            SELECT COUNT(DISTINCT song_id) 
            FROM song_hashtags 
            WHERE collected_date = '2025-07-16'
        """)
        july16_hashtag_songs = cursor.fetchone()[0]
        print(f"ğŸ“… 7ì›” 16ì¼ í•´ì‹œíƒœê·¸ ìˆ˜ì§‘ ê³¡: {july16_hashtag_songs}ê°œ")
        
        # 7. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¸
        cursor.execute("PRAGMA table_info(songs)")
        schema = cursor.fetchall()
        print(f"\nğŸ“‹ songs í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ:")
        for column in schema:
            print(f"   {column[1]}: {column[2]} (null: {column[3]})")
        
        print("=" * 70)

if __name__ == "__main__":
    debug_july16_issue()