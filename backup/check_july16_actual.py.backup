#!/usr/bin/env python3
"""
7ì›” 16ì¼ ì‹¤ì œ ìˆ˜ì§‘ ì‹œê°„ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '.'))
from src.database import database_manager as db
from datetime import datetime

def check_july16_actual():
    """7ì›” 16ì¼ ì‹¤ì œ ìˆ˜ì§‘ ì‹œê°„ í™•ì¸"""
    
    with db.get_db_connection() as conn:
        cursor = conn.cursor()
        
        print("=" * 70)
        print("ðŸ• 7ì›” 16ì¼ ì‹¤ì œ ìˆ˜ì§‘ ì‹œê°„ í™•ì¸")
        print("=" * 70)
        
        # ì •í™•í•œ ì‹œê°„ ë²”ìœ„ë¡œ ê²€ìƒ‰ (7ì›” 16ì¼ 01:30 ~ 02:00)
        cursor.execute("""
            SELECT title, artist, tiktok_ugc_count, youtube_ugc_count, ugc_last_updated
            FROM songs 
            WHERE ugc_last_updated >= '2025-07-16 01:30:00' 
              AND ugc_last_updated <= '2025-07-16 02:00:00'
            ORDER BY ugc_last_updated DESC
        """)
        july16_updates = cursor.fetchall()
        
        print(f"ðŸ“… 7ì›” 16ì¼ 01:30-02:00 ì‹œê°„ëŒ€ ì—…ë°ì´íŠ¸: {len(july16_updates)}ê³¡")
        
        if july16_updates:
            print("   ðŸ“Š ìˆ˜ì§‘ëœ ê³¡ ëª©ë¡:")
            for i, song in enumerate(july16_updates, 1):
                tiktok_count = f"{song[2]:,}" if song[2] else "ë¯¸ìˆ˜ì§‘"
                youtube_count = f"{song[3]:,}" if song[3] else "ë¯¸ìˆ˜ì§‘"
                print(f"   {i:2d}. {song[0]} - {song[1]}")
                print(f"       TikTok: {tiktok_count}, YouTube: {youtube_count}")
                print(f"       ì—…ë°ì´íŠ¸: {song[4]}")
                print()
        else:
            print("   âŒ í•´ë‹¹ ì‹œê°„ëŒ€ ì—…ë°ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
        
        # ë” ë„“ì€ ë²”ìœ„ ê²€ìƒ‰ (7ì›” 16ì¼ ì „ì²´)
        cursor.execute("""
            SELECT title, artist, tiktok_ugc_count, youtube_ugc_count, ugc_last_updated
            FROM songs 
            WHERE ugc_last_updated >= '2025-07-16 00:00:00' 
              AND ugc_last_updated < '2025-07-17 00:00:00'
            ORDER BY ugc_last_updated DESC
        """)
        july16_all = cursor.fetchall()
        
        print(f"ðŸ“… 7ì›” 16ì¼ ì „ì²´ ì—…ë°ì´íŠ¸: {len(july16_all)}ê³¡")
        
        if july16_all:
            print("   ðŸ“Š ì‹œê°„ëŒ€ë³„ ë¶„í¬:")
            time_groups = {}
            for song in july16_all:
                hour = song[4].split(' ')[1][:2]  # ì‹œê°„ ë¶€ë¶„ ì¶”ì¶œ
                if hour not in time_groups:
                    time_groups[hour] = []
                time_groups[hour].append(song)
            
            for hour in sorted(time_groups.keys()):
                print(f"   {hour}ì‹œ: {len(time_groups[hour])}ê³¡")
                for song in time_groups[hour][:3]:  # ê° ì‹œê°„ëŒ€ë³„ ìƒìœ„ 3ê³¡
                    print(f"      - {song[0]} - {song[1]} ({song[4]})")
        
        # í•´ì‹œíƒœê·¸ ìˆ˜ì§‘ í™•ì¸
        cursor.execute("""
            SELECT COUNT(DISTINCT s.song_id) as songs_with_hashtags,
                   COUNT(*) as total_hashtags
            FROM song_hashtags s
            JOIN songs song ON s.song_id = song.id
            WHERE song.ugc_last_updated >= '2025-07-16 00:00:00' 
              AND song.ugc_last_updated < '2025-07-17 00:00:00'
        """)
        hashtag_stats = cursor.fetchone()
        
        print(f"\nðŸ“Œ 7ì›” 16ì¼ í•´ì‹œíƒœê·¸ ìˆ˜ì§‘:")
        print(f"   ðŸŽµ í•´ì‹œíƒœê·¸ ìˆ˜ì§‘ ê³¡: {hashtag_stats[0]}ê³¡")
        print(f"   ðŸ“Š ì´ í•´ì‹œíƒœê·¸ ìˆ˜: {hashtag_stats[1]}ê°œ")
        
        print("=" * 70)

if __name__ == "__main__":
    check_july16_actual()