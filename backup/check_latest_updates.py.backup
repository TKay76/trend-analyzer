#!/usr/bin/env python3
"""
ìµœì‹  ì—…ë°ì´íŠ¸ ì‹œê°„ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '.'))
from src.database import database_manager as db
from datetime import datetime

def check_latest_updates():
    """ìµœì‹  ì—…ë°ì´íŠ¸ ì‹œê°„ í™•ì¸"""
    
    with db.get_db_connection() as conn:
        cursor = conn.cursor()
        
        print("=" * 70)
        print("ğŸ• ìµœì‹  ì—…ë°ì´íŠ¸ ì‹œê°„ í™•ì¸")
        print("=" * 70)
        
        # ê°€ì¥ ìµœê·¼ ì—…ë°ì´íŠ¸ ì‹œê°„
        cursor.execute("""
            SELECT MAX(ugc_last_updated) as latest_update
            FROM songs 
            WHERE ugc_last_updated IS NOT NULL
        """)
        latest_update = cursor.fetchone()[0]
        
        if latest_update:
            print(f"ğŸ“… ê°€ì¥ ìµœê·¼ ì—…ë°ì´íŠ¸: {latest_update}")
            
            # ìµœê·¼ ì—…ë°ì´íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° í™•ì¸
            cursor.execute("""
                SELECT DATE(ugc_last_updated) as update_date,
                       COUNT(*) as total_updates,
                       COUNT(CASE WHEN tiktok_ugc_count IS NOT NULL THEN 1 END) as tiktok_updates,
                       COUNT(CASE WHEN youtube_ugc_count IS NOT NULL THEN 1 END) as youtube_updates
                FROM songs 
                WHERE ugc_last_updated IS NOT NULL
                GROUP BY DATE(ugc_last_updated)
                ORDER BY update_date DESC
                LIMIT 5
            """)
            recent_updates = cursor.fetchall()
            
            print("\nğŸ“Š ìµœê·¼ 5ì¼ê°„ ì—…ë°ì´íŠ¸ í˜„í™©:")
            for update_date, total, tiktok, youtube in recent_updates:
                print(f"   ğŸ“… {update_date}: ì´ {total}ê³¡ (TikTok {tiktok}ê³¡, YouTube {youtube}ê³¡)")
        else:
            print("âŒ ì—…ë°ì´íŠ¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
        
        # ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
        today = datetime.now().strftime('%Y-%m-%d')
        print(f"\nğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ: {today}")
        
        # ì˜¤ëŠ˜ ì—…ë°ì´íŠ¸ëœ ë°ì´í„° í™•ì¸
        cursor.execute("""
            SELECT title, artist, tiktok_ugc_count, youtube_ugc_count, ugc_last_updated
            FROM songs 
            WHERE DATE(ugc_last_updated) = ?
            ORDER BY ugc_last_updated DESC
            LIMIT 10
        """, (today,))
        today_updates = cursor.fetchall()
        
        print(f"\nğŸ¯ ì˜¤ëŠ˜({today}) ì—…ë°ì´íŠ¸ í˜„í™©:")
        if today_updates:
            print(f"   ğŸ“Š ì´ {len(today_updates)}ê³¡ ì—…ë°ì´íŠ¸")
            for song in today_updates:
                tiktok_count = f"{song[2]:,}" if song[2] else "ë¯¸ìˆ˜ì§‘"
                youtube_count = f"{song[3]:,}" if song[3] else "ë¯¸ìˆ˜ì§‘"
                print(f"   ğŸµ {song[0]} - {song[1]}")
                print(f"      TikTok: {tiktok_count}, YouTube: {youtube_count}")
                print(f"      ì—…ë°ì´íŠ¸: {song[4]}")
                print()
        else:
            print("   âŒ ì˜¤ëŠ˜ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        
        print("=" * 70)

if __name__ == "__main__":
    check_latest_updates()